# 청킹 전략 정의서

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 청킹 전략 정의서 |
| 버전 | 1.0 |
| 작성일 | 2026-01-07 |
| 목적 | RAG 시스템을 위한 문서 청킹 규칙 정의 |

---

## 1. 청킹 개요

### 1.1 청킹이란?

**청킹(Chunking)**은 긴 문서를 작은 조각(chunk)으로 나누어 벡터 데이터베이스에 저장하는 과정이다. 적절한 청킹은 RAG 시스템의 검색 품질을 결정하는 핵심 요소이다.

### 1.2 청킹이 중요한 이유

| 청크 크기 | 장점 | 단점 |
|----------|------|------|
| 너무 작음 | 정밀한 검색 가능 | 문맥 손실, 의미 불완전 |
| 너무 큼 | 충분한 문맥 유지 | 검색 정확도 저하, 노이즈 증가 |
| 적정 크기 | 문맥 유지 + 정밀 검색 | - |

### 1.3 적용 대상 문서

| 문서명 | 용도 |
|--------|------|
| MSA_정의서.md | MSA 기본 개념, 구성 요소, 분리 기준 |
| 도메인_분석_가이드.md | DDD 기반 도메인 분석 방법론 |
| (추가 예정) | 언어별 패턴 가이드, 안티패턴 등 |

---

## 2. 청킹 전략

### 2.1 선택한 전략: 섹션 단위 + 메타데이터

```
┌─────────────────────────────────────────────────────────────┐
│                      청킹 전략 요약                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 기본 분리 단위: ### (H3) 소제목                          │
│  2. 크기 제한: 200자 ~ 1000자                                │
│  3. 메타데이터 필수 포함                                     │
│  4. 오버랩: 이전 청크 마지막 문장 포함                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 청킹 규칙

#### 규칙 1: 기본 분리 단위

```
# (H1)  → 문서 제목, 청킹 대상 아님
## (H2) → 대분류, 단독 청킹 안 함
### (H3) → 기본 청킹 단위 ✅
#### (H4) → H3에 포함하여 청킹
```

#### 규칙 2: 크기 제한

| 조건 | 처리 방법 |
|------|----------|
| 200자 미만 | 상위 섹션(H2)과 병합 |
| 200자 ~ 1000자 | 그대로 사용 ✅ |
| 1000자 초과 | 하위 항목(-, 표, 코드블록)으로 추가 분리 |

#### 규칙 3: 메타데이터 구조

모든 청크에 다음 메타데이터를 포함한다:

```json
{
  "id": "msa-def-2-1",
  "document": "MSA_정의서.md",
  "section": "2.1 서비스",
  "parent_section": "2. MSA 구성 요소",
  "tags": ["서비스", "bounded-context", "자율성", "API"],
  "chunk_type": "definition",
  "language": "ko",
  "version": "1.0"
}
```

#### 규칙 4: 청크 타입 분류

| chunk_type | 설명 | 예시 |
|------------|------|------|
| definition | 개념 정의 | "MSA란...", "Bounded Context란..." |
| comparison | 비교 설명 | "모놀리식 vs MSA" |
| checklist | 체크리스트 | "서비스 분리 체크리스트" |
| example | 예시/사례 | "이커머스 MSA 구조" |
| guide | 가이드/절차 | "Bounded Context 식별 방법" |
| pattern | 패턴 설명 | "Saga 패턴", "CQRS" |
| warning | 주의사항 | "안티패턴", "분리하면 안 되는 경우" |

#### 규칙 5: 오버랩 (Overlap)

문맥 유지를 위해 이전 청크의 마지막 1-2문장을 다음 청크 시작에 포함한다.

```
┌─────────────────────────────────────────┐
│ Chunk 1                                 │
│ ...                                     │
│ 마지막 문장 A                            │
│ 마지막 문장 B  ──────────────┐           │
└─────────────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────┐
│ Chunk 2                                 │
│ [오버랩] 마지막 문장 B                    │
│ 새로운 내용 시작...                      │
│ ...                                     │
└─────────────────────────────────────────┘
```

---

## 3. 청킹 예시

### 3.1 MSA_정의서.md 청킹 예시

#### 원본 섹션

```markdown
### 2.1 서비스 (Service)

독립적인 비즈니스 기능 단위로, 다음 특성을 갖는다:

- **자율성**: 독립적으로 개발, 테스트, 배포 가능
- **경계 컨텍스트 (Bounded Context)**: 명확한 도메인 경계 보유
- **API 기반 통신**: 표준화된 인터페이스로 외부와 소통
- **데이터 소유권**: 자체 데이터 저장소 보유 및 관리
```

#### 청크 결과

```json
{
  "metadata": {
    "id": "msa-def-2-1",
    "document": "MSA_정의서.md",
    "section": "2.1 서비스",
    "parent_section": "2. MSA 구성 요소",
    "tags": ["서비스", "service", "자율성", "bounded-context", "API", "데이터소유권"],
    "chunk_type": "definition",
    "language": "ko",
    "version": "1.0"
  },
  "content": "서비스 (Service)는 독립적인 비즈니스 기능 단위로, 다음 특성을 갖는다: 자율성 - 독립적으로 개발, 테스트, 배포 가능. 경계 컨텍스트 (Bounded Context) - 명확한 도메인 경계 보유. API 기반 통신 - 표준화된 인터페이스로 외부와 소통. 데이터 소유권 - 자체 데이터 저장소 보유 및 관리."
}
```

### 3.2 도메인_분석_가이드.md 청킹 예시

#### 원본 섹션

```markdown
### 4.1 이커머스 (E-Commerce)

| 서비스 | 책임 | 유형 |
|--------|------|------|
| User | 회원 가입, 인증, 프로필 관리 | Supporting |
| Catalog | 상품 정보, 검색, 카테고리 | Core |
| Cart | 장바구니 관리 | Supporting |
| Order | 주문 생성, 상태 관리 | Core |
| Payment | 결제 처리, 환불 | Generic |
| Inventory | 재고 관리, 입출고 | Supporting |
| Shipping | 배송 추적, 배송사 연동 | Generic |
| Review | 상품 리뷰, 평점 | Supporting |
```

#### 청크 결과

```json
{
  "metadata": {
    "id": "domain-guide-4-1",
    "document": "도메인_분석_가이드.md",
    "section": "4.1 이커머스",
    "parent_section": "4. 도메인별 분리 예시",
    "tags": ["이커머스", "e-commerce", "쇼핑몰", "User", "Order", "Payment", "Catalog"],
    "chunk_type": "example",
    "language": "ko",
    "version": "1.0"
  },
  "content": "이커머스 (E-Commerce) MSA 서비스 분리 예시: User 서비스 - 회원 가입, 인증, 프로필 관리 (Supporting). Catalog 서비스 - 상품 정보, 검색, 카테고리 (Core). Cart 서비스 - 장바구니 관리 (Supporting). Order 서비스 - 주문 생성, 상태 관리 (Core). Payment 서비스 - 결제 처리, 환불 (Generic). Inventory 서비스 - 재고 관리, 입출고 (Supporting). Shipping 서비스 - 배송 추적, 배송사 연동 (Generic). Review 서비스 - 상품 리뷰, 평점 (Supporting)."
}
```

---

## 4. 태그 체계

### 4.1 태그 분류

효과적인 검색을 위해 태그를 체계적으로 관리한다.

#### 카테고리 태그

| 카테고리 | 태그 예시 |
|----------|----------|
| 아키텍처 | MSA, 모놀리식, 분산시스템 |
| 구성요소 | API-Gateway, Service-Discovery, Circuit-Breaker |
| 통신 | REST, gRPC, 이벤트, 메시지큐, Kafka |
| 데이터 | CQRS, Saga, Event-Sourcing, 분산트랜잭션 |
| 도메인 | DDD, Bounded-Context, 서브도메인 |
| 패턴 | ACL, Shared-Kernel, Customer-Supplier |

#### 도메인 예시 태그

| 도메인 | 태그 예시 |
|--------|----------|
| 이커머스 | 이커머스, 쇼핑몰, 주문, 결제, 배송 |
| 소셜미디어 | 소셜, 피드, 팔로우, 게시물 |
| SaaS | SaaS, 멀티테넌트, 구독, 빌링 |
| 핀테크 | 핀테크, 금융, 송금, 계좌, KYC |

### 4.2 태그 생성 규칙

```
1. 섹션 제목에서 핵심 키워드 추출
2. 본문에서 중요 용어 추출 (굵은 글씨, 첫 등장 용어)
3. 영문/한글 태그 모두 포함
4. 동의어 포함 (예: 서비스 → service)
5. 관련 상위/하위 개념 포함
```

---

## 5. 청킹 프로세스

### 5.1 전체 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                      청킹 프로세스                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 문서 파싱                                            │
│ - Markdown 구조 분석                                         │
│ - H1, H2, H3 헤딩 식별                                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 섹션 분리                                            │
│ - H3 기준으로 1차 분리                                       │
│ - 크기 검증 (200자 ~ 1000자)                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 크기 조정                                            │
│ - 너무 작으면 병합                                           │
│ - 너무 크면 추가 분리                                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 4: 메타데이터 생성                                       │
│ - ID 부여                                                    │
│ - 태그 추출                                                  │
│ - chunk_type 분류                                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 5: 오버랩 적용                                          │
│ - 이전 청크 마지막 문장 추가                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 6: 임베딩 및 저장                                       │
│ - Voyage AI로 임베딩                                         │
│ - Supabase pgvector에 저장                                   │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 구현 시 고려사항

| 항목 | 고려사항 |
|------|----------|
| 테이블 처리 | 테이블은 텍스트로 변환하여 저장 |
| 코드 블록 | 코드 블록은 별도 청크로 분리하지 않음 |
| 다이어그램 | ASCII 다이어그램은 설명과 함께 저장 |
| 리스트 | 리스트 항목은 문장 형태로 변환 |
| 링크/참조 | 내부 링크는 제거, 참조 문서명만 유지 |

---

## 6. 데이터베이스 스키마

### 6.1 Supabase 테이블 구조

```sql
-- 청크 저장 테이블
CREATE TABLE chunks (
  id TEXT PRIMARY KEY,
  document TEXT NOT NULL,
  section TEXT NOT NULL,
  parent_section TEXT,
  content TEXT NOT NULL,
  tags TEXT[],
  chunk_type TEXT,
  language TEXT DEFAULT 'ko',
  version TEXT,
  embedding VECTOR(1024),  -- Voyage AI 임베딩 차원
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 벡터 검색 인덱스
CREATE INDEX ON chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 태그 검색 인덱스
CREATE INDEX ON chunks USING GIN (tags);
```

### 6.2 검색 쿼리 예시

```sql
-- 유사도 검색
SELECT 
  id,
  document,
  section,
  content,
  tags,
  1 - (embedding <=> $1) AS similarity
FROM chunks
WHERE 1 - (embedding <=> $1) > 0.7
ORDER BY similarity DESC
LIMIT 5;

-- 태그 + 유사도 복합 검색
SELECT 
  id,
  document,
  section,
  content,
  1 - (embedding <=> $1) AS similarity
FROM chunks
WHERE 
  tags && ARRAY['이커머스', '서비스분리']
  AND 1 - (embedding <=> $1) > 0.5
ORDER BY similarity DESC
LIMIT 5;
```

---

## 7. 품질 검증

### 7.1 청킹 품질 체크리스트

| 항목 | 체크 |
|------|------|
| 모든 청크가 200자 이상인가? | ☐ |
| 모든 청크가 1000자 이하인가? | ☐ |
| 메타데이터가 누락 없이 포함되었는가? | ☐ |
| 태그가 3개 이상 포함되었는가? | ☐ |
| chunk_type이 올바르게 분류되었는가? | ☐ |
| 오버랩이 적용되었는가? | ☐ |
| 문맥이 손실되지 않았는가? | ☐ |

### 7.2 검색 품질 테스트

청킹 완료 후 다음 질문으로 검색 품질을 테스트한다:

| 테스트 질문 | 기대 결과 (상위 청크) |
|------------|----------------------|
| "MSA에서 서비스란?" | MSA_정의서 2.1 서비스 |
| "서비스 분리 기준은?" | MSA_정의서 5.2 분리 기준 체크리스트 |
| "이커머스 MSA 구조" | 도메인_분석_가이드 4.1 이커머스 |
| "Bounded Context 식별 방법" | 도메인_분석_가이드 2.2 식별 방법 |
| "동기 통신 vs 비동기 통신" | MSA_정의서 3.3 통신 방식 선택 기준 |

---

## 8. 문서별 예상 청크 수

### 8.1 MSA_정의서.md

| 섹션 | 예상 청크 수 |
|------|-------------|
| 1. MSA 개요 | 3 |
| 2. MSA 구성 요소 | 7 |
| 3. 서비스 간 통신 | 4 |
| 4. 데이터 관리 | 3 |
| 5. 서비스 분리 기준 | 3 |
| 6. MSA 도입 시 고려사항 | 3 |
| 7. MSA 분석 AI 서비스 설계 가이드 | 4 |
| 8. 참고 자료 | 2 |
| **합계** | **약 29개** |

### 8.2 도메인_분석_가이드.md

| 섹션 | 예상 청크 수 |
|------|-------------|
| 1. 도메인 분석 개요 | 3 |
| 2. Bounded Context 식별 | 3 |
| 3. 서브도메인 분류 | 3 |
| 4. 도메인별 분리 예시 | 4 |
| 5. 도메인 관계 패턴 | 3 |
| 6. 실전 분석 체크리스트 | 3 |
| 7. 코드 분석 시 도메인 힌트 | 3 |
| **합계** | **약 22개** |

### 8.3 전체 예상

| 문서 | 청크 수 |
|------|--------|
| MSA_정의서.md | ~29 |
| 도메인_분석_가이드.md | ~22 |
| (추가 문서) | TBD |
| **총 예상** | **~51+** |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2026-01-07 | 최초 작성 | - |
