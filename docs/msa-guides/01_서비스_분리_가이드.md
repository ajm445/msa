# MSA 서비스 분리 가이드

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | MSA 서비스 분리 가이드 |
| 버전 | 1.0 |
| 목적 | 마이크로서비스 경계 설정 및 분리 기준 제공 |

---

## 1. 도메인 주도 설계 (DDD) 기반 분리

### 1.1 DDD란?

**DDD(Domain-Driven Design)**는 복잡한 소프트웨어를 도메인 전문가와 개발자가 협력하여 도메인 모델 중심으로 설계하는 방법론이다.

**핵심 개념**:
- **도메인**: 소프트웨어가 해결하려는 비즈니스 문제 영역
- **유비쿼터스 언어**: 팀 전체가 공유하는 공통 용어
- **모델**: 도메인의 핵심 개념을 표현한 추상화

### 1.2 전략적 설계 vs 전술적 설계

| 구분 | 전략적 설계 | 전술적 설계 |
|------|------------|------------|
| 범위 | 시스템 전체 | 개별 서비스 내부 |
| 초점 | 서비스 경계, 컨텍스트 | 엔티티, 값 객체, 애그리거트 |
| 주요 개념 | Bounded Context, Context Map | Entity, Value Object, Repository |
| MSA 적용 | 서비스 분리 기준 | 서비스 내부 구조 |

---

## 2. Bounded Context (바운디드 컨텍스트)

### 2.1 정의

**Bounded Context**는 특정 도메인 모델이 적용되는 명확한 경계를 의미한다. 동일한 용어라도 컨텍스트에 따라 다른 의미를 가질 수 있다.

**예시 - "주문" 용어의 다른 의미**:

| 컨텍스트 | "주문"의 의미 |
|----------|--------------|
| 판매 컨텍스트 | 고객이 구매 요청한 상품 목록 |
| 배송 컨텍스트 | 배송해야 할 물품과 주소 정보 |
| 결제 컨텍스트 | 청구해야 할 금액 정보 |
| 재고 컨텍스트 | 출고해야 할 상품 수량 |

### 2.2 Bounded Context 식별 방법

**1단계: 도메인 이벤트 식별**
- 비즈니스에서 발생하는 중요한 사건 나열
- "~가 되었다", "~가 완료되었다" 형식

**2단계: 명령(Command) 식별**
- 이벤트를 발생시키는 행위 파악
- "~를 한다", "~를 요청한다" 형식

**3단계: 집합체(Aggregate) 식별**
- 관련된 데이터와 행위를 묶음
- 일관성 경계 설정

**4단계: 컨텍스트 경계 설정**
- 유사한 집합체들을 그룹화
- 팀 구조와 조직 고려

### 2.3 Context Map

서비스 간 관계를 표현하는 다이어그램:

| 관계 유형 | 설명 | 예시 |
|----------|------|------|
| **Shared Kernel** | 공유 모델 사용 | 공통 라이브러리 |
| **Customer-Supplier** | 상류-하류 관계 | 주문→결제 |
| **Conformist** | 하류가 상류 모델 따름 | 외부 API 연동 |
| **Anti-Corruption Layer** | 변환 계층 도입 | 레거시 연동 |
| **Open Host Service** | 공개 API 제공 | 공용 서비스 |
| **Published Language** | 표준 프로토콜 사용 | JSON Schema |

---

## 3. 서비스 분리 기준

### 3.1 비즈니스 기능 기반 분리

**원칙**: 하나의 서비스는 하나의 비즈니스 기능(Capability)을 담당

**분리 체크리스트**:
- [ ] 독립적인 비즈니스 가치를 제공하는가?
- [ ] 다른 기능 없이 단독으로 의미가 있는가?
- [ ] 별도 팀이 소유하고 운영할 수 있는가?

**예시 - 이커머스 시스템**:
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   회원      │  │   상품      │  │   주문      │
│   서비스    │  │   서비스    │  │   서비스    │
└─────────────┘  └─────────────┘  └─────────────┘
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   결제      │  │   배송      │  │   리뷰      │
│   서비스    │  │   서비스    │  │   서비스    │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 3.2 데이터 소유권 기반 분리

**원칙**: 데이터의 주인이 명확한 단위로 분리

**체크리스트**:
- [ ] 이 데이터의 생성/수정/삭제 권한이 명확한가?
- [ ] 다른 서비스는 이 데이터를 읽기만 하는가?
- [ ] 데이터 일관성 범위가 이 서비스 내에 한정되는가?

### 3.3 변경 빈도 기반 분리

**원칙**: 변경 주기가 다른 기능은 분리

| 변경 유형 | 예시 | 분리 이유 |
|----------|------|----------|
| 자주 변경 | 프로모션, UI | 빠른 배포 필요 |
| 드물게 변경 | 결제, 인증 | 안정성 우선 |
| 규제 대응 | 개인정보, 금융 | 감사/컴플라이언스 |

### 3.4 확장 요구 기반 분리

**원칙**: 확장(Scale) 요구가 다른 기능은 분리

**예시**:
- **검색 서비스**: 읽기 트래픽 많음 → 읽기 복제본 확장
- **주문 서비스**: 피크 시간 집중 → 오토스케일링
- **배치 서비스**: CPU 집약적 → 별도 인스턴스

### 3.5 기술 요구 기반 분리

**원칙**: 특수한 기술 스택이 필요한 기능은 분리

| 기능 | 기술 요구 | 분리 이유 |
|------|----------|----------|
| 실시간 알림 | WebSocket, Redis | 특수 인프라 |
| 이미지 처리 | GPU, Python | 고성능 컴퓨팅 |
| 검색 | Elasticsearch | 전문 검색 엔진 |
| ML 추천 | TensorFlow | AI/ML 프레임워크 |

---

## 4. 팀 구조와 서비스 경계

### 4.1 Conway's Law (콘웨이 법칙)

> "시스템 구조는 그것을 만든 조직의 커뮤니케이션 구조를 반영한다"

**의미**: 서비스 경계는 팀 경계와 일치시키는 것이 효과적

### 4.2 팀 토폴로지 패턴

**Stream-aligned Team (스트림 정렬 팀)**
- 특정 비즈니스 도메인 담당
- 독립적으로 기능 제공
- 예: 주문팀, 결제팀

**Platform Team (플랫폼 팀)**
- 공통 인프라/서비스 제공
- 다른 팀의 생산성 지원
- 예: 인프라팀, 플랫폼팀

**Enabling Team (지원 팀)**
- 기술 역량 전파
- 일시적 지원
- 예: SRE팀, 아키텍처팀

### 4.3 Two Pizza Team 원칙

**정의**: 피자 두 판으로 식사할 수 있는 규모의 팀 (5-9명)

**이점**:
- 의사소통 효율성
- 책임감 증가
- 빠른 의사결정

---

## 5. 서비스 크기 결정

### 5.1 적정 크기 판단 기준

| 지표 | 너무 작음 | 적정 | 너무 큼 |
|------|----------|------|--------|
| 코드 라인 | < 1,000 | 1,000~50,000 | > 100,000 |
| 팀 규모 | 1명 | 3~8명 | > 15명 |
| 재작성 시간 | < 1일 | 1~4주 | > 3개월 |
| API 엔드포인트 | < 3개 | 5~20개 | > 50개 |
| 테이블 수 | 1개 | 3~15개 | > 30개 |

### 5.2 서비스가 너무 작을 때의 문제

- 네트워크 통신 오버헤드 증가
- 분산 트랜잭션 복잡도 증가
- 운영 및 모니터링 부담
- 배포 파이프라인 증가

### 5.3 서비스가 너무 클 때의 문제

- 모놀리식의 단점 재현
- 독립적 배포 어려움
- 팀 간 조율 필요
- 기술 부채 축적

---

## 6. 서비스 분리 체크리스트

### 6.1 분리 전 확인사항

| 항목 | 질문 | 확인 |
|------|------|------|
| 비즈니스 독립성 | 이 기능은 독립적인 비즈니스 가치가 있는가? | □ |
| 데이터 경계 | 명확한 데이터 소유권이 있는가? | □ |
| 변경 독립성 | 다른 서비스 변경 없이 배포 가능한가? | □ |
| 팀 소유권 | 이 서비스를 책임질 팀이 있는가? | □ |
| 확장 요구 | 독립적인 확장이 필요한가? | □ |
| 장애 격리 | 이 서비스 장애가 다른 서비스에 영향을 주는가? | □ |

### 6.2 분리 후 확인사항

| 항목 | 질문 | 확인 |
|------|------|------|
| 순환 의존성 | 서비스 간 순환 호출이 없는가? | □ |
| 동기 통신 | 불필요한 동기 호출이 없는가? | □ |
| 데이터 중복 | 적절한 수준의 데이터 복제인가? | □ |
| API 계약 | 명확한 API 계약이 정의되었는가? | □ |
| 장애 대응 | Fallback 처리가 구현되었는가? | □ |

---

## 7. 실전 예시

### 7.1 이커머스 서비스 분리 예시

**Before (모놀리식)**:
```
┌─────────────────────────────────────┐
│           E-Commerce App            │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│  │회원 │ │상품 │ │주문 │ │결제 │   │
│  └─────┘ └─────┘ └─────┘ └─────┘   │
│         ┌──────────────┐            │
│         │  공유 DB     │            │
│         └──────────────┘            │
└─────────────────────────────────────┘
```

**After (MSA)**:
```
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│  회원   │ │  상품   │ │  주문   │ │  결제   │
│ Service │ │ Service │ │ Service │ │ Service │
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │           │           │           │
┌────▼────┐ ┌────▼────┐ ┌────▼────┐ ┌────▼────┐
│ User DB │ │Product  │ │Order DB │ │Payment  │
│         │ │   DB    │ │         │ │   DB    │
└─────────┘ └─────────┘ └─────────┘ └─────────┘
```

### 7.2 분리 기준 적용

| 서비스 | 분리 이유 |
|--------|----------|
| 회원 서비스 | 인증/인가 독립, 보안 요구사항 별도 |
| 상품 서비스 | 카탈로그 관리, 검색 최적화 필요 |
| 주문 서비스 | 핵심 비즈니스, 트랜잭션 집중 |
| 결제 서비스 | PCI-DSS 컴플라이언스, 외부 연동 |

---

## 8. 참고 자료

### 8.1 핵심 용어

| 용어 | 설명 |
|------|------|
| DDD | Domain-Driven Design, 도메인 주도 설계 |
| Bounded Context | 특정 도메인 모델이 적용되는 경계 |
| Ubiquitous Language | 팀 전체가 공유하는 도메인 용어 |
| Aggregate | 일관성 경계를 가진 엔티티 집합 |
| Context Map | 바운디드 컨텍스트 간 관계 다이어그램 |
| Conway's Law | 시스템 구조가 조직 구조를 반영한다는 법칙 |

### 8.2 추천 도서

- "도메인 주도 설계" - Eric Evans
- "도메인 주도 설계 핵심" - Vaughn Vernon
- "마이크로서비스 패턴" - Chris Richardson
- "팀 토폴로지" - Matthew Skelton

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2025-01-07 | 최초 작성 |
